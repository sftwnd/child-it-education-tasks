# Операционные системы

## 5. Кэш памяти

Большинство современных операционных систем являются мультипрограммными и используют концепцию виртуальной памяти. Это означает, что в исполняемом коде каждой программы используются виртуальные адреса, отсчитываемые от **0** для каждой программы, а при обращении к ячейке памяти по виртуальному адресу операционная система осуществляет пересчет его в физический адрес. Эта процедура может отнимать значительное время, поэтому при организации вычислительного процесса важным элементом является кэш памяти.

Кэш памяти представляет собой ассоциативный массив, хранящий пары типа «ключ-значение», где в качестве ключа выступает виртуальный адрес, а в качестве значения вычисленный физический. Без использования кэша при каждом обращении программы к ячейке памяти приходилось бы осуществлять преобразование виртуального адреса в физический, что существенно замедляло бы вычисления. В случае использования кэша, для начала производится поиск виртуального адреса в кэше. Если виртуальный адрес там нашелся, физический адрес берется из кэша. Такая ситуация называется «кэш попадание». Если виртуального адреса в кэше не оказалось, запускается процедура вычисления физического адреса. Такая ситуация называется **«кэш промах»**. В случае кэш промаха в кэш помещается новая пара **«виртуальный адрес – физический адрес»**, вытесняя ту пару, которая дольше всего не использовалась.

В зависимости от архитектуры вычислительной системы, кэш памяти может использоваться как для всех операций обращения, связанных с обращением к ячейке памяти, так и только для конкретных, например, только операций чтения данных из ячейки памяти в регистр процессора.

Рассмотрим следующую модель вычислительной системы с кэшем памяти:

1.	Программа представляет собой набор 16-битных инструкций, для удобства записанных в виде четырехразрядных шестнадцатеричных чисел. Старший разряд является номером исполняемой команды, а младшие 3 разряда – виртуальным адресом ячейки памяти, которая используется этой командой. В записи инструкции используются арабские цифры и строчные буквы из диапазона a-f.
2.	Кэш памяти используется только для команд чтения ячейки памяти в регистр процессора, которым соответствует значение старшего шестнадцатеричного разряда инструкции **«1»**. Например, инструкция **100a** означает чтение данных из ячейки с виртуальным адресом **00a**. Для любых других команд (инструкций, у которых старший шестнадцатеричный разряд отличается от 1) кэш памяти не используется.
3.	Кэш памяти состоит из четырех ячеек, пронумерованных от **0** до **3** и изначально пустых. Каждая ячейка кроме пары «виртуальный адрес – физический адрес» хранит также счетчик. При выполнении каждой операции чтения выполняются следующие действия:
a. Осуществляется попытка найти в кэше памяти виртуальный адрес, указанный в выполняемой инструкции.
b. Если такой адрес найден в кэше (кэш попадание), счетчик для него устанавливается в 0.
c. Если такой адрес не найден в кэше (кэш промах), то после вычисления физического адреса определяется пустая ячейка с минимальным номером, а если пустых ячеек нет, то определяется ячейка, значение счетчика которой максимально (если таких ячеек несколько, из них берется ячейка с минимальным номером). В эту ячейку помещается новая пара «виртуальный адрес – физический адрес», а счетчик этой ячейки устанавливается в 0.
d. Независимо от того, получилось ли в результате выполнения инструкции кэш попадание или кэш промах, счетчики всех четырех ячеек увеличиваются на 1.
Вам дан файл с программой. Определите количество кэш попаданий, которое произошло при выполнении этой программы. В ответе запишите целое число.

Вам дан [файл с программой](./test.txt), или [вариант теста №2](./test1.txt), или [вариант теста №3](./test2.txt).

Определите количество кэш попаданий, которое произошло при выполнении этой программы. В ответе запишите целое число.

Для реализации подсчёта можно написать программу: [«Её код на GitHub»](./cache.cpp)

Как вариант - можно вырезать из текста только строки, начинающиеся на 1, импортировать их в [Excel]("./5.%20Операционные%20системы%20-%20Кэш памяти.xlsx") и заполнить первый столбец.
Результат должен отобразиться в левом верхнем углу. 
